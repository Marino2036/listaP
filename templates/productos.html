// Abrir y cerrar modal
const modal = document.getElementById("modal");
document.getElementById("abrirModal").onclick = () => modal.style.display = "block";
document.getElementById("cerrarModal").onclick = () => modal.style.display = "none";

// Simulación guardar producto
document.getElementById("formulario").onsubmit = function (e) {
  e.preventDefault();
  const nombre = document.getElementById("nombre").value;
  const precio = document.getElementById("precio").value;
  const categoria = document.getElementById("categoria").value;
  const codigo = document.getElementById("codigo").value;

  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${nombre}</td><td>$${precio}</td><td>${categoria}</td><td><a href="#">Editar</a></td>`;
  document.getElementById("tablaProductos").appendChild(tr);

  modal.style.display = "none";
  this.reset();
};

// Buscar producto (básico)
function buscarProducto() {
  const texto = document.getElementById("busqueda").value.toLowerCase();
  const filas = document.querySelectorAll("#tablaProductos tr");
  filas.forEach(fila => {
    fila.style.display = fila.innerText.toLowerCase().includes(texto) ? "" : "none";
  });
}

// Escanear en pantalla principal
function iniciarEscaner() {
  const video = document.getElementById("video");
  video.style.display = "block";

  if (!('BarcodeDetector' in window)) {
    alert("BarcodeDetector no soportado");
    return;
  }

  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      video.srcObject = stream;
      const detector = new BarcodeDetector({ formats: ['ean_13', 'code_128', 'upc_a'] });

      const scan = () => {
        detector.detect(video)
          .then(codes => {
            if (codes.length > 0) {
              alert("Código detectado: " + codes[0].rawValue);
              stream.getTracks().forEach(track => track.stop());
              video.style.display = "none";
            } else {
              requestAnimationFrame(scan);
            }
          });
      };

      scan();
    });
}

// Escanear desde modal
function escanearDesdeModal() {
  if (!('BarcodeDetector' in window)) {
    alert("Tu navegador no soporta BarcodeDetector.");
    return;
  }

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      const video = document.createElement("video");
      video.setAttribute("playsinline", true);
      video.srcObject = stream;
      video.play();

      const detector = new BarcodeDetector();
      const escanear = () => {
        detector.detect(video)
          .then(codes => {
            if (codes.length > 0) {
              document.getElementById("codigo").value = codes[0].rawValue;
              stream.getTracks().forEach(t => t.stop());
            } else {
              requestAnimationFrame(escanear);
            }
          });
      };
      escanear();
    });
}
