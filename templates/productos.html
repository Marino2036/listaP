<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lista de Productos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        .camara-container {
            display: none;
            margin-top: 20px;
        }
        .logo {
            height: 60px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="Logo">
            <h1 class="text-primary">Lista de Productos</h1>
            <a href="/pdf" class="btn btn-outline-danger">Descargar PDF</a>
        </div>

        <!-- Men√∫ desplegable por categor√≠a -->
        <div class="mb-3">
            <label for="categoria" class="form-label">Filtrar por categor√≠a:</label>
            <select id="categoria" class="form-select" onchange="filtrarCategoria()">
                <option value="Todas">Todas</option>
                {% for categoria in categorias %}
                <option value="{{ categoria }}">{{ categoria }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Buscar producto -->
        <div class="mb-3">
            <input type="text" id="busqueda" class="form-control" onkeyup="buscarProducto()" placeholder="Buscar producto...">
        </div>

        <!-- Bot√≥n para encender/apagar c√°mara -->
        <div class="mb-3">
            <button class="btn btn-success" onclick="toggleCamara()">üì∑ Escanear C√≥digo de Barras</button>
        </div>

        <!-- Esc√°ner de c√≥digo de barras -->
        <div class="camara-container" id="camara-container">
            <div id="reader" style="width: 300px;"></div>
            <button class="btn btn-secondary mt-2" onclick="detenerCamara()">‚ùå Apagar C√°mara</button>
        </div>

        <!-- Lista de productos -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tabla-productos">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Categor√≠a</th>
                        <th>C√≥digo de Barras</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr data-categoria="{{ producto.categoria }}">
                        <td>{{ producto.nombre }}</td>
                        <td>${{ producto.precio }}</td>
                        <td>{{ producto.categoria }}</td>
                        <td>{{ producto.codigo_barras or '' }}</td>
                        <td>
                            <a href="/editar/{{ producto.id }}" class="btn btn-sm btn-warning">Editar</a>
                            <a href="/eliminar/{{ producto.id }}" class="btn btn-sm btn-danger">Eliminar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Agregar producto -->
        <hr>
        <h3>Agregar Producto</h3>
        <form action="/agregar" method="post">
            <div class="mb-3">
                <input type="text" name="nombre" class="form-control" placeholder="Nombre" required>
            </div>
            <div class="mb-3">
                <input type="number" name="precio" class="form-control" placeholder="Precio" required>
            </div>
            <div class="mb-3">
                <input type="text" name="categoria" class="form-control" placeholder="Categor√≠a" required>
            </div>
            <div class="mb-3">
                <input type="text" name="codigo_barras" class="form-control" placeholder="C√≥digo de Barras (opcional)">
            </div>
            <button type="submit" class="btn btn-primary">Agregar</button>
        </form>
    </div>

    <script>
        function filtrarCategoria() {
            const categoria = document.getElementById("categoria").value;
            const filas = document.querySelectorAll("#tabla-productos tbody tr");

            filas.forEach(fila => {
                const cat = fila.getAttribute("data-categoria");
                fila.style.display = (categoria === "Todas" || cat === categoria) ? "" : "none";
            });
        }

        function buscarProducto() {
            const texto = document.getElementById("busqueda").value.toLowerCase();
            const filas = document.querySelectorAll("#tabla-productos tbody tr");

            filas.forEach(fila => {
                const contenido = fila.textContent.toLowerCase();
                fila.style.display = contenido.includes(texto) ? "" : "none";
            });
        }

        let scanner = null;
        let camaraActiva = false;

        function toggleCamara() {
            if (camaraActiva) {
                detenerCamara();
            } else {
                iniciarCamara();
            }
        }

        function iniciarCamara() {
            document.getElementById("camara-container").style.display = "block";
            scanner = new Html5Qrcode("reader");
            scanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    document.getElementById("busqueda").value = decodedText;
                    buscarProducto();
                    detenerCamara();
                },
                (errorMessage) => {
                    // console.log(`Error escaneando: ${errorMessage}`);
                }
            ).then(() => {
                camaraActiva = true;
            }).catch(err => {
                console.error("Error al iniciar c√°mara:", err);
            });
        }

        function detenerCamara() {
            if (scanner) {
                scanner.stop().then(() => {
                    scanner.clear();
                    document.getElementById("camara-container").style.display = "none";
                    camaraActiva = false;
                }).catch(err => {
                    console.error("Error al detener c√°mara:", err);
                });
            }
        }
    </script>
</body>
</html>
